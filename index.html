<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ระบบประกาศผลคะแนน</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  
  <style>
    body { box-sizing: border-box; font-family: 'Sarabun', sans-serif; background-color: #f0fdf4; color: #4b5563; -webkit-tap-highlight-color: transparent; }
    .gradient-bg { background-color: #C6E686; } 
    .btn-primary { background: linear-gradient(135deg, #fcd34d 0%, #fbbf24 100%); color: #78350f; transition: all 0.2s ease; cursor: pointer; }
    .btn-primary:active { transform: scale(0.96); }
    .input-field { background-color: #f9fafb; border: 1px solid #e5e7eb; transition: all 0.2s ease; }
    .input-field:focus { background-color: white; border-color: #C6E686; box-shadow: 0 0 0 3px rgba(198, 230, 134, 0.4); outline: none; }
    .sidebar-btn { width: 100%; text-align: left; padding: 12px 16px; margin-bottom: 8px; border-radius: 12px; display: flex; align-items: center; gap: 12px; color: #4b5563; background: transparent; border: none; cursor: pointer; min-height: 48px; }
    .sidebar-btn:active { background-color: #ecfdf5; }
    .sidebar-btn.active { background-color: #eefad2; color: #5a7a1a; font-weight: 600; }
    .modal-overlay { background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(8px); }
    #student-modal { transition: opacity 0.2s ease; z-index: 100; } 
    body.modal-active { overflow: hidden !important; }
    .hidden-force { display: none !important; }
    .tab-btn { border-bottom: 3px solid transparent; color: #9ca3af; padding: 12px 16px; transition: all 0.2s; white-space: nowrap; cursor: pointer; }
    .tab-btn.active { border-bottom: 3px solid #84cc16; color: #4d7c0f; font-weight: bold; background-color: #f7fee7; }
  </style>

  <script>
    // -----------------------------------------------------------
    // ใส่ URL ของ Google Apps Script V2 ตรงนี้
    // -----------------------------------------------------------
    const API_URL = "https://script.google.com/macros/s/AKfycbxjl2-P7ia1wsrY_ptExFJWUWI4VUU8GKL9-XYujPSt-0TNAuEXNRw-VLibzq9cH0o/exec"; 

    async function callApi(action, data = {}) {
        const body = JSON.stringify({ action, ...data });
        const response = await fetch(API_URL, {
            method: 'POST', body: body, headers: { "Content-Type": "text/plain;charset=utf-8" } 
        });
        return await response.json();
    }

    // --- Logic คำนวณผลการคัดเลือก (สำคัญมาก) ---
    function calculateAdmissions(students) {
        // เคลียร์ผลเก่าก่อน
        students.forEach(s => s.admission_result = null);

        // แยกกลุ่ม ม.1 และ ม.4
        const m1Students = students.filter(s => ['p4','p5','p6','m1'].includes(s.grade_level.toLowerCase())).sort((a,b) => b.total_score - a.total_score);
        const m4Students = students.filter(s => ['m3','m4'].includes(s.grade_level.toLowerCase())).sort((a,b) => b.total_score - a.total_score);

        // --- Logic ม.1 ---
        // 1. S&M: 80 คนแรก (เฉพาะคนที่เลือกอันดับ 1)
        let smQuota = 80;
        let smCount = 0;
        m1Students.forEach(s => {
            if (s.choice_1 === 'S&M' && smCount < smQuota) {
                s.admission_result = 'S&M';
                smCount++;
            }
        });

        // 2. GATE: 60 คนแรก (ที่ยังไม่ติด S&M และเลือก GATE เป็น 1 หรือ 2)
        let gateQuotaM1 = 60;
        let gateCountM1 = 0;
        m1Students.forEach(s => {
            if (!s.admission_result && (s.choice_1 === 'GATE' || s.choice_2 === 'GATE') && gateCountM1 < gateQuotaM1) {
                s.admission_result = 'GATE';
                gateCountM1++;
            }
        });

        // 3. EIS: 60 คนแรก (ที่ยังไม่ติด และเลือก EIS เป็น 1, 2 หรือ 3)
        let eisQuota = 60;
        let eisCount = 0;
        m1Students.forEach(s => {
            if (!s.admission_result && (s.choice_1 === 'EIS' || s.choice_2 === 'EIS' || s.choice_3 === 'EIS') && eisCount < eisQuota) {
                s.admission_result = 'EIS';
                eisCount++;
            }
        });

        // --- Logic ม.4 ---
        // 1. SME: 80 คนแรก (เฉพาะคนที่เลือกอันดับ 1)
        let smeQuota = 80;
        let smeCount = 0;
        m4Students.forEach(s => {
            if (s.choice_1 === 'SME' && smeCount < smeQuota) {
                s.admission_result = 'SME';
                smeCount++;
            }
        });

        // 2. GATE: 60 คนแรก (ที่ยังไม่ติด SME และเลือก GATE เป็น 1 หรือ 2)
        let gateQuotaM4 = 60;
        let gateCountM4 = 0;
        m4Students.forEach(s => {
            if (!s.admission_result && (s.choice_1 === 'GATE' || s.choice_2 === 'GATE') && gateCountM4 < gateQuotaM4) {
                s.admission_result = 'GATE';
                gateCountM4++;
            }
        });

        return [...m1Students, ...m4Students].sort((a, b) => parseFloat(a.exam_id) - parseFloat(b.exam_id));
    }

    window.dataSdk = {
      init: async (handler) => { window.dataSdkHandler = handler; await window.dataSdk.refresh(); return { isOk: true }; },
      refresh: async () => { 
        try {
            const res = await callApi('getAllStudents');
            if (res.success) { 
                let mappedData = res.students.map(s => ({ ...s, __backendId: s.id })); 
                // คำนวณผลสอบทันทีที่โหลดข้อมูล
                mappedData = calculateAdmissions(mappedData);
                
                if (window.dataSdkHandler?.onDataChanged) window.dataSdkHandler.onDataChanged(mappedData); 
                return { isOk: true, data: mappedData }; 
            } 
            return { isOk: false, error: { message: res.message } };
        } catch(e) { return { isOk: false, error: { message: e.message } }; }
      },
      create: async (data) => {
        try { const res = await callApi('createStudent', { data }); if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; } return { isOk: false, error: { message: res.message } }; } catch(e) { return { isOk: false, error: { message: e.message } }; }
      },
      createBulk: async (dataArray) => {
        try { const res = await callApi('createStudentsBulk', { data: dataArray }); if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; } return { isOk: false, error: { message: res.message } }; } catch(e) { return { isOk: false, error: { message: e.message } }; }
      },
      updateScoresBulk: async (dataArray) => {
        try { const res = await callApi('updateScoresBulk', { data: dataArray }); if(res.success) { await window.dataSdk.refresh(); return { isOk: true, message: res.message }; } return { isOk: false, error: { message: res.message } }; } catch(e) { return { isOk: false, error: { message: e.message } }; }
      },
      update: async (data) => {
        try { const updateData = { ...data, id: data.__backendId }; const res = await callApi('updateStudent', { data: updateData }); if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; } return { isOk: false, error: { message: res.message } }; } catch(e) { return { isOk: false, error: { message: e.message } }; }
      },
      delete: async (data) => {
        try { const res = await callApi('deleteStudent', { id: data.__backendId }); if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; } return { isOk: false, error: { message: res.message } }; } catch(e) { return { isOk: false, error: { message: e.message } }; }
      },
      deleteBulk: async (ids) => {
        try { const res = await callApi('deleteStudentsBulk', { ids }); if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; } return { isOk: false, error: { message: res.message } }; } catch(e) { return { isOk: false, error: { message: e.message } }; }
      }
    };
  </script>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full"></div>

  <div id="student-modal" class="hidden-force fixed inset-0 flex items-center justify-center z-[100]">
    <div class="modal-overlay absolute w-full h-full" onclick="closeModal()"></div>
    <div class="bg-white w-full h-full md:w-11/12 md:h-auto md:max-w-4xl md:max-h-[90vh] md:rounded-[2rem] shadow-2xl z-[101] flex flex-col border border-lime-100 relative transform transition-all">
      <div class="flex justify-between items-center px-6 py-4 bg-gradient-to-r from-lime-50 to-white border-b border-lime-100 shrink-0">
        <div class="flex items-center gap-3"><p class="text-lg md:text-xl font-bold text-lime-800" id="modal-title">จัดการข้อมูล</p></div>
        <button type="button" class="text-gray-400 hover:text-red-500 p-2" onclick="closeModal()">X</button>
      </div>

      <div id="add-mode-tabs" class="flex px-4 border-b border-gray-100 bg-gray-50/50 hidden overflow-x-auto shrink-0">
        <button type="button" onclick="switchAddTab('single')" id="tab-single" class="tab-btn active flex-1 md:flex-none">เพิ่มทีละคน</button>
        <button type="button" onclick="switchAddTab('multiple')" id="tab-multiple" class="tab-btn flex-1 md:flex-none">เพิ่มหลายคน</button>
        <button type="button" onclick="switchAddTab('excel')" id="tab-excel" class="tab-btn flex-1 md:flex-none">Import ชื่อ</button>
        <button type="button" onclick="switchAddTab('score')" id="tab-score" class="tab-btn flex-1 md:flex-none text-purple-600 font-bold">Import คะแนน</button>
      </div>

      <div class="overflow-y-auto p-4 md:p-8 flex-1 bg-white">
        <div id="view-single" class="block pb-20 md:pb-0">
            <form id="student-form" onsubmit="handleSingleSubmit(event)">
                <input type="hidden" id="student-backend-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
                    <div><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">เลขบัตรประชาชน</label><input type="text" id="form-national-id" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field" placeholder="00xxxxxxxxxxx" required></div>
                    <div><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">รหัสประจำตัวสอบ</label><input type="text" id="form-exam-id" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field" required></div>
                    <div><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">ระดับชั้น</label><select id="form-grade" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field bg-white" onchange="updateChoiceOptions()"><option value="p4">ประถมศึกษาปีที่ 4</option><option value="p5">ประถมศึกษาปีที่ 5</option><option value="p6">ประถมศึกษาปีที่ 6</option><option value="m3">มัธยมศึกษาปีที่ 3</option></select></div>
                    <div><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">ชื่อ-นามสกุล</label><input type="text" id="form-name" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field" required></div>
                    <div class="md:col-span-2"><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">โรงเรียนเดิม</label><input type="text" id="form-school" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field"></div>
                    
                    <div class="md:col-span-2 bg-blue-50 p-4 rounded-xl border border-blue-100">
    <label class="block text-blue-800 text-sm font-bold mb-3">เลือกโครงการ</label>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div><label class="text-xs text-gray-500">อันดับ 1</label><select id="form-choice-1" class="w-full p-2 rounded border border-gray-200 text-sm"><option value="">- เลือก -</option></select></div>
        <div><label class="text-xs text-gray-500">อันดับ 2</label><select id="form-choice-2" class="w-full p-2 rounded border border-gray-200 text-sm"><option value="">- เลือก -</option></select></div>
        
        <div id="div-choice-3"><label class="text-xs text-gray-500">อันดับ 3</label><select id="form-choice-3" class="w-full p-2 rounded border border-gray-200 text-sm"><option value="">- เลือก -</option></select></div>
    </div>
</div>
                
                <div id="score-section" class="bg-amber-50/50 p-4 md:p-6 rounded-2xl border border-amber-100">
                    <h3 class="text-sm font-bold text-amber-600 mb-4 uppercase">คะแนนสอบ</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4">
                        <div><label class="text-xs text-gray-500 font-semibold">วิทยาศาสตร์ (40)</label><input type="number" step="0.01" id="score-science" class="w-full px-3 py-2 rounded-lg border-gray-200 text-center font-bold text-lime-600 input-field"></div>
                        <div><label class="text-xs text-gray-500 font-semibold">คณิตศาสตร์ (30)</label><input type="number" step="0.01" id="score-math" class="w-full px-3 py-2 rounded-lg border-gray-200 text-center font-bold text-lime-600 input-field"></div>
                        <div><label class="text-xs text-gray-500 font-semibold">ภาษาอังกฤษ (30)</label><input type="number" step="0.01" id="score-english" class="w-full px-3 py-2 rounded-lg border-gray-200 text-center font-bold text-lime-600 input-field"></div>
                    </div>
                </div>
                <div class="flex justify-end pt-6 gap-3">
                  <button type="button" onclick="closeModal()" class="px-6 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">ยกเลิก</button>
                  <button type="submit" class="px-8 py-3 btn-primary rounded-xl font-bold">บันทึก</button>
                </div>
            </form>
        </div>
        <div id="view-multiple" class="hidden h-full flex flex-col"><div class="flex-1 overflow-auto border border-gray-100 rounded-xl mb-4 shadow-inner bg-gray-50/50"><table class="w-full text-sm text-left text-gray-500" id="multiple-table"><thead class="text-xs text-gray-500 uppercase bg-gray-100 sticky top-0"><tr><th class="px-2 py-3">เลขบัตร</th><th class="px-2 py-3">รหัส</th><th class="px-2 py-3">ชื่อ</th><th class="px-2 py-3">ชั้น</th><th class="px-2 py-3">รร.</th><th class="px-1 py-3">ลบ</th></tr></thead><tbody id="multiple-tbody" class="bg-white"></tbody></table></div><div class="flex justify-between items-center bg-white p-2 rounded-lg gap-2"><button type="button" onclick="addMultipleRow()" class="flex-1 text-lime-600 font-bold bg-lime-50 px-3 py-3 rounded-lg">+ เพิ่มแถว</button><button type="button" onclick="handleMultipleSubmit()" class="flex-1 btn-primary px-3 py-3 rounded-lg font-bold text-yellow-900 shadow-md">บันทึก</button></div></div>
         <div id="view-excel" class="hidden"><div class="border-2 border-dashed border-lime-200 bg-lime-50/30 rounded-2xl p-6 md:p-10 text-center hover:bg-lime-50 transition-colors cursor-pointer" id="drop-zone-name"><label for="excel-upload-name" class="cursor-pointer block"><span class="block text-lg font-bold text-lime-700">เลือกไฟล์ Excel (รายชื่อ)</span><input id="excel-upload-name" type="file" class="hidden" accept=".xlsx, .xls" onchange="handleExcelUpload(this, 'student')"></label></div><div class="mt-6 bg-amber-50 p-6 rounded-2xl border border-amber-100"><h4 class="font-bold text-amber-700 mb-2">คำแนะนำ</h4><ul class="text-sm text-amber-800 space-y-1 ml-7 list-disc"><li>A: รหัสสอบ</li><li>B: เลขบัตรฯ</li><li>C: ชื่อ-นามสกุล</li><li>D: ชั้น</li><li>E: รร.เดิม</li><li>F: อันดับ 1</li><li>G: อันดับ 2</li><li>H: อันดับ 3</li></ul></div><div id="excel-preview-area" class="mt-6 hidden"><div class="flex justify-between items-center mb-3"><h4 class="font-bold text-gray-700 text-sm">ข้อมูล (<span id="excel-count">0</span> คน)</h4><button type="button" onclick="confirmExcelImport('student')" class="px-4 py-2 btn-primary rounded-lg font-bold text-sm shadow-md">ยืนยัน</button></div><div class="overflow-auto max-h-48 border border-gray-200 rounded-xl text-xs bg-white"><table class="w-full text-left" id="excel-preview-table"></table></div></div></div>
         <div id="view-score" class="hidden"><div class="border-2 border-dashed border-purple-200 bg-purple-50/30 rounded-2xl p-6 md:p-10 text-center hover:bg-purple-50 transition-colors cursor-pointer" id="drop-zone-score"><label for="excel-upload-score" class="cursor-pointer block"><span class="block text-lg font-bold text-purple-700">เลือกไฟล์ Excel (คะแนน)</span><input id="excel-upload-score" type="file" class="hidden" accept=".xlsx, .xls" onchange="handleExcelUpload(this, 'score')"></label></div></div>
      </div>
    </div>
  </div>

  <div id="alert-modal" class="hidden-force fixed inset-0 flex items-center justify-center z-[200] px-4"><div class="modal-overlay absolute w-full h-full" onclick="closeAlert()"></div><div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-6 text-center relative z-[201] border border-lime-50"><h3 class="text-lg font-bold text-gray-800 mb-2" id="alert-title">แจ้งเตือน</h3><p class="text-gray-500 mb-6 text-sm" id="alert-message">ข้อความ</p><button onclick="closeAlert()" class="w-full py-3 bg-lime-400 text-white rounded-xl font-bold shadow-md">ตกลง</button></div></div>
  <div id="confirm-modal" class="hidden-force fixed inset-0 flex items-center justify-center z-[200] px-4"><div class="modal-overlay absolute w-full h-full" onclick="closeConfirm()"></div><div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-6 text-center relative z-[201] border border-amber-50"><h3 class="text-lg font-bold text-gray-800 mb-2" id="confirm-title">ยืนยัน</h3><p class="text-gray-500 mb-6 text-sm" id="confirm-message">ดำเนินการ?</p><div class="flex gap-3"><button onclick="closeConfirm()" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">ยกเลิก</button><button onclick="confirmAction()" class="flex-1 py-3 bg-amber-400 text-white rounded-xl font-bold shadow-md">ยืนยัน</button></div></div></div>
  <div id="loading-modal" class="hidden-force fixed inset-0 flex items-center justify-center z-[300]"><div class="modal-overlay absolute w-full h-full bg-white/80 backdrop-blur-sm"></div><div class="bg-white rounded-3xl shadow-xl p-6 w-48 text-center relative z-[301] border border-lime-50"><div class="mx-auto w-12 h-12 border-4 border-lime-100 border-t-lime-500 rounded-full animate-spin mb-3"></div><p class="text-lime-600 font-bold text-sm" id="loading-message">กำลังโหลด...</p></div></div>
  
  <script>
    const defaultConfig = { 
        system_title: "ระบบประกาศผลคะแนน<br>การสอบแข่งขันทักษะวิชาการเพชรราชพฤกษ์<br><span class='text-sm font-normal'>โรงเรียนบางสะพานวิทยา จังหวัดประจวบคีรีขันธ์</span>", 
        admission_year: "2569", 
        primary_color: "#C6E686", 
        secondary_color: "#fbbf24", 
        background_color: "#f0fdf4", 
        text_color: "#374151", 
        surface_color: "#ffffff" 
    };

    let currentUser = null, currentView = 'login', adminTab = 'm1', studentsData = [], searchQuery = '', formMode = 'create', excelDataCache = [], scoreDataCache = [], confirmCallback = null, isSidebarOpen = false, checkedIds = new Set();

    function getThaiGrade(code) { const map = { 'p4': 'ประถมศึกษาปีที่ 4', 'p5': 'ประถมศึกษาปีที่ 5', 'p6': 'ประถมศึกษาปีที่ 6', 'm3': 'มัธยมศึกษาปีที่ 3' }; return map[code.toLowerCase()] || code; }
    function toggleSidebar() { const sb=document.getElementById('sidebar'), ov=document.getElementById('sidebar-overlay'); isSidebarOpen=!isSidebarOpen; if(isSidebarOpen){sb.classList.remove('-translate-x-full');ov.classList.remove('hidden');}else{sb.classList.add('-translate-x-full');ov.classList.add('hidden');} }
    
    // Modal Helpers
    function showAlert(t, m) { document.getElementById('alert-title').textContent = t; document.getElementById('alert-message').textContent = m; document.getElementById('alert-modal').classList.remove('hidden-force'); }
    function closeAlert() { document.getElementById('alert-modal').classList.add('hidden-force'); }
    function showConfirm(t, m, cb) { document.getElementById('confirm-title').textContent = t; document.getElementById('confirm-message').textContent = m; confirmCallback = cb; document.getElementById('confirm-modal').classList.remove('hidden-force'); }
    function closeConfirm() { document.getElementById('confirm-modal').classList.add('hidden-force'); confirmCallback = null; }
    function confirmAction() { if(confirmCallback) confirmCallback(); closeConfirm(); }
    function showLoading(msg) { document.getElementById('loading-message').textContent = msg; document.getElementById('loading-modal').classList.remove('hidden-force'); }
    function hideLoading() { document.getElementById('loading-modal').classList.add('hidden-force'); }
    function openModal() { document.getElementById('student-modal').classList.remove('hidden-force'); document.body.classList.add('modal-active'); updateChoiceOptions(); }
    function closeModal() { document.getElementById('student-modal').classList.add('hidden-force'); document.body.classList.remove('modal-active'); }

    // --- Options for Choices ---
    // ฟังก์ชันอัปเดตตัวเลือกห้องเรียนโครงการ
    // 1. ฟังก์ชันอัปเดตตัวเลือก (แก้ให้ ม.4 เหลือแค่ 2 ตัวเลือก และซ่อนอันดับ 3)
    function updateChoiceOptions() {
        const grade = document.getElementById('form-grade').value;
        const choice3Div = document.getElementById('div-choice-3'); // ใช้ ID ที่ตั้งใหม่
        const choice3Select = document.getElementById('form-choice-3');
        
        const choices = ['form-choice-1', 'form-choice-2'];
        let options = [];

        if (['p4','p5','p6'].includes(grade)) {
            // ม.1: มี 3 อันดับ
            options = ['S&M', 'GATE', 'EIS', 'ทั่วไป'];
            choice3Div.classList.remove('hidden'); // แสดงอันดับ 3
            
            // อัปเดตตัวเลือกอันดับ 3
            const val3 = choice3Select.value;
            choice3Select.innerHTML = '<option value="">- เลือก -</option>' + options.map(o => `<option value="${o}">${o}</option>`).join('');
            choice3Select.value = val3;
        } else {
            // ม.4: มีแค่ SME กับ GATE และซ่อนอันดับ 3
            options = ['SME', 'GATE']; // ตัด 'ทั่วไป' ออกตามโจทย์
            
            choice3Div.classList.add('hidden'); // ซ่อนอันดับ 3
            choice3Select.value = ''; // ล้างค่าทิ้ง
        }

        // อัปเดตอันดับ 1 และ 2
        choices.forEach(id => {
            const el = document.getElementById(id);
            const val = el.value;
            el.innerHTML = '<option value="">- เลือก -</option>' + options.map(o => `<option value="${o}">${o}</option>`).join('');
            el.value = val;
        });
    }

    // 2. ฟังก์ชันเปิด Modal แก้ไข (เพิ่มการเรียก updateChoiceOptions)
    function showEditForm(id) { 
        formMode = 'update'; 
        document.getElementById('modal-title').textContent = 'แก้ไขข้อมูล';
        document.getElementById('add-mode-tabs').classList.add('hidden'); 
        ['single','multiple','excel','score'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden')); 
        document.getElementById('view-single').classList.remove('hidden'); 
        document.getElementById('score-section').classList.remove('hidden'); 
        
        const s = studentsData.find(x => x.__backendId === id); if(!s) return; 
        
        // ใส่ข้อมูลลงฟอร์ม
        document.getElementById('student-backend-id').value = s.__backendId; 
        document.getElementById('form-national-id').value = s.national_id || ''; 
        document.getElementById('form-exam-id').value = s.exam_id; 
        document.getElementById('form-grade').value = s.grade_level; 
        document.getElementById('form-name').value = s.full_name; 
        document.getElementById('form-school').value = s.previous_school; 
        document.getElementById('score-science').value = s.science_score; 
        document.getElementById('score-math').value = s.math_score; 
        document.getElementById('score-english').value = s.english_score; 
        
        // สำคัญ: เรียกอัปเดตตัวเลือกก่อน แล้วค่อยใส่ค่า Choice
        updateChoiceOptions(); 
        
        setTimeout(() => {
            document.getElementById('form-choice-1').value = s.choice_1 || '';
            document.getElementById('form-choice-2').value = s.choice_2 || '';
            document.getElementById('form-choice-3').value = s.choice_3 || '';
        }, 50);
        
        openModal(); 
    }

    // 3. ฟังก์ชันเปิด Modal เพิ่ม (เพิ่มการเรียก updateChoiceOptions)
    function showAddStudentForm() { 
        formMode = 'create'; 
        document.getElementById('modal-title').textContent = 'เพิ่มผู้เข้าสอบใหม่';
        document.getElementById('student-form').reset(); 
        document.getElementById('add-mode-tabs').classList.remove('hidden'); 
        document.getElementById('score-section').classList.add('hidden'); 
        switchAddTab('single'); 
        
        updateChoiceOptions(); // เรียกทันทีที่เปิด
        openModal(); 
    }

    // 4. ฟังก์ชันแสดงผลหน้าผู้เข้าสอบ (แก้ให้แสดง Choice ที่เลือก)
    function renderStudentView() {
       if(!currentUser) return;
       
       const maxSci = 40; const maxMath = 30; const maxEng = 30; const maxTotal = 100;
       
       const sSci = parseFloat(currentUser.science_score)||0;
       const sMath = parseFloat(currentUser.math_score)||0;
       const sEng = parseFloat(currentUser.english_score)||0;
       const sTotal = sSci + sMath + sEng;
       
       const pSci = (sSci/maxSci)*100;
       const pMath = (sMath/maxMath)*100;
       const pEng = (sEng/maxEng)*100;

       const thaiGrade = getThaiGrade(currentUser.grade_level);
       const isSecondary = ['m3', 'm4'].includes(currentUser.grade_level.toLowerCase());

       document.getElementById('app').innerHTML = `
          <div class="h-full bg-[#fdfbf7] overflow-auto">
             <div class="gradient-bg h-48 w-full absolute top-0 left-0 z-0 rounded-b-[3rem] shadow-lg opacity-90"></div>
             <div class="relative z-10 max-w-4xl mx-auto p-4 pt-8 pb-10">
                
                <div class="flex justify-between items-start mb-6">
                    <div class="flex flex-col">
                        <span class="text-lg md:text-xl font-bold text-lime-900 leading-tight">ประกาศผลคะแนนการสอบ</span>
                        <span class="text-lg md:text-xl font-bold text-lime-900 leading-tight">แข่งขันทักษะวิชาการเพชรราชพฤกษ์</span>
                        <span class="text-lg md:text-xl font-bold text-lime-900 leading-tight">ปีการศึกษา 2569</span>
                        <span class="text-lime-800 font-medium text-sm mt-2">โรงเรียนบางสะพานวิทยา จังหวัดประจวบคีรีขันธ์</span>
                    </div>
                    <button onclick="currentView='login';render()" class="shrink-0 bg-white/80 backdrop-blur-sm text-red-500 hover:bg-red-500 hover:text-white px-4 py-2 rounded-full text-xs font-bold shadow-sm transition-all border border-red-100 ml-2">ออกจากระบบ</button>
                </div>
                
                <div class="bg-white rounded-[2rem] p-6 shadow-xl mb-6 relative overflow-hidden border border-lime-100">
                   <div class="absolute top-0 right-0 w-32 h-32 bg-lime-50 rounded-full -mr-10 -mt-10 opacity-60"></div>
                   
                   <div class="flex flex-col md:flex-row items-center gap-6 relative z-10">
                        <div class="flex-1 text-center md:text-left w-full">
                            <h2 class="text-2xl font-bold text-gray-800 mb-1">${currentUser.full_name}</h2>
                            <p class="text-lime-600 font-medium mb-4 text-sm">${thaiGrade}</p>
                            
                            ${currentUser.admission_result 
                                ? `<div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-xl text-center"><p class="text-green-800 font-bold text-lg">ขอแสดงความยินดี</p><p class="text-green-600">ผ่านการคัดเลือกเข้าศึกษาต่อโครงการ <span class="font-bold text-xl block mt-1">${currentUser.admission_result}</span></p></div>` 
                                : `<div class="mb-4 p-4 bg-gray-50 border border-gray-200 rounded-xl text-center"><p class="text-gray-500">ยังไม่ผ่านเกณฑ์การคัดเลือกในรอบโควตา</p></div>`
                            }

                            <div class="grid grid-cols-1 gap-3 text-gray-600 text-sm mb-4">
                                <div class="bg-gray-50 px-4 py-3 rounded-xl border border-gray-100 flex justify-between"><span>เลขประจำตัวสอบ</span><span class="font-bold text-gray-800">${currentUser.exam_id}</span></div>
                                <div class="bg-gray-50 px-4 py-3 rounded-xl border border-gray-100 flex justify-between"><span>ลำดับที่ (คะแนนรวม)</span><span class="font-bold text-blue-600">#${currentUser.rank}</span></div>
                            </div>

                            <div class="border-t border-gray-100 pt-4">
                                <p class="text-xs text-gray-400 font-bold mb-2 text-left">ลำดับการเลือกห้องเรียนโครงการ</p>
                                <div class="grid ${isSecondary ? 'grid-cols-2' : 'grid-cols-3'} gap-2">
                                    <div class="bg-blue-50/50 border border-blue-100 p-2 rounded-lg text-center">
                                        <span class="block text-[10px] text-blue-400 font-bold uppercase">อันดับ 1</span>
                                        <span class="text-sm font-bold text-gray-700 truncate block">${currentUser.choice_1 || '-'}</span>
                                    </div>
                                    <div class="bg-blue-50/50 border border-blue-100 p-2 rounded-lg text-center">
                                        <span class="block text-[10px] text-blue-400 font-bold uppercase">อันดับ 2</span>
                                        <span class="text-sm font-bold text-gray-700 truncate block">${currentUser.choice_2 || '-'}</span>
                                    </div>
                                    ${!isSecondary ? `
                                    <div class="bg-blue-50/50 border border-blue-100 p-2 rounded-lg text-center">
                                        <span class="block text-[10px] text-blue-400 font-bold uppercase">อันดับ 3</span>
                                        <span class="text-sm font-bold text-gray-700 truncate block">${currentUser.choice_3 || '-'}</span>
                                    </div>` : ''}
                                </div>
                            </div>

                        </div>
                   </div>
                </div>
                
                <h3 class="text-gray-600 font-bold text-lg mb-4 ml-2 flex items-center gap-2">คะแนนรายวิชา</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                   <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-2 relative overflow-hidden group hover:shadow-md transition-shadow">
                        <div class="absolute right-0 top-0 w-16 h-16 bg-blue-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                        <div class="flex justify-between items-center mb-1 relative z-10"><span class="text-gray-600 text-xs font-bold uppercase tracking-wider">วิทยาศาสตร์</span><span class="text-[10px] text-gray-400 font-bold bg-gray-50 px-2 py-0.5 rounded-full border border-gray-100">เต็ม ${maxSci}</span></div>
                        <div class="flex justify-between items-end relative z-10"><span class="text-3xl font-bold text-gray-800">${sSci}</span><span class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-lg">ร้อยละ ${pSci.toFixed(1)}</span></div>
                        <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden mt-3 relative z-10"><div class="bg-blue-400 h-2 rounded-full" style="width: ${pSci}%"></div></div>
                   </div>
                   <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-2 relative overflow-hidden group hover:shadow-md transition-shadow">
                        <div class="absolute right-0 top-0 w-16 h-16 bg-red-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                        <div class="flex justify-between items-center mb-1 relative z-10"><span class="text-gray-600 text-xs font-bold uppercase tracking-wider">คณิตศาสตร์</span><span class="text-[10px] text-gray-400 font-bold bg-gray-50 px-2 py-0.5 rounded-full border border-gray-100">เต็ม ${maxMath}</span></div>
                        <div class="flex justify-between items-end relative z-10"><span class="text-3xl font-bold text-gray-800">${sMath}</span><span class="text-[10px] font-bold text-red-600 bg-red-50 px-2 py-1 rounded-lg">ร้อยละ ${pMath.toFixed(1)}</span></div>
                        <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden mt-3 relative z-10"><div class="bg-red-400 h-2 rounded-full" style="width: ${pMath}%"></div></div>
                   </div>
                   <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-2 relative overflow-hidden group hover:shadow-md transition-shadow">
                        <div class="absolute right-0 top-0 w-16 h-16 bg-purple-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                        <div class="flex justify-between items-center mb-1 relative z-10"><span class="text-gray-600 text-xs font-bold uppercase tracking-wider">ภาษาอังกฤษ</span><span class="text-[10px] text-gray-400 font-bold bg-gray-50 px-2 py-0.5 rounded-full border border-gray-100">เต็ม ${maxEng}</span></div>
                        <div class="flex justify-between items-end relative z-10"><span class="text-3xl font-bold text-gray-800">${sEng}</span><span class="text-[10px] font-bold text-purple-600 bg-purple-50 px-2 py-1 rounded-lg">ร้อยละ ${pEng.toFixed(1)}</span></div>
                        <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden mt-3 relative z-10"><div class="bg-purple-400 h-2 rounded-full" style="width: ${pEng}%"></div></div>
                   </div>
                </div>

                 <div class="bg-gradient-to-br from-amber-50 via-orange-50 to-white rounded-3xl p-6 border border-amber-100 text-center relative overflow-hidden shadow-sm">
                    <div class="absolute top-0 left-0 w-full h-full bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9IiNmYmJmMjQiIGZpbGwtb3BhY2l0eT0iMC4yIi8+PC9zdmc+')] opacity-30"></div>
                    <div class="relative z-10 flex flex-col items-center">
                        <p class="text-amber-700 font-bold uppercase tracking-widest text-xs mb-2">คะแนนรวม 3 วิชา (เต็ม ${maxTotal})</p>
                        <div class="flex items-baseline gap-2"><p class="text-5xl font-black text-amber-500 drop-shadow-sm tracking-tight">${sTotal.toFixed(2)}</p></div>
                        <span class="text-xs font-bold text-amber-700 bg-amber-100/50 px-4 py-1.5 rounded-full mt-3 border border-amber-200">คิดเป็นร้อยละ ${((sTotal/maxTotal)*100).toFixed(1)}</span>
                    </div>
                 </div>
                 
                 <div class="mt-8 mb-4 text-center border-t border-gray-200/50 pt-4">
                    <p class="text-xs text-gray-400 font-medium">พัฒนาระบบโดย ครูอานนท์ เมืองแก้ว</p>
                 </div>
             </div>
          </div>
       `;
    }

    const dataHandler = { onDataChanged(data) { 
        // เรียงตามเลขสอบเป็นหลัก (แต่ Rank ถูกคำนวณใน Backend/Calculate Function แล้ว)
        studentsData = data.sort((a, b) => parseFloat(a.exam_id) - parseFloat(b.exam_id));
        if (currentView === 'admin') renderAdminDashboard(); 
        else if (currentView === 'student' && currentUser) { 
            const u = studentsData.find(s => String(s.national_id) === String(currentUser.national_id)); 
            if(u) currentUser = u; 
            renderStudentView(); 
        } 
    }};
    
    function render() { const app = document.getElementById('app'); if(currentView === 'login') renderLogin(); else if(currentView === 'admin') renderAdminDashboard(); else renderStudentView(); }
    
    function toggleAllCheckboxes(source) { const checkboxes = document.querySelectorAll('.row-checkbox'); checkboxes.forEach(cb => { cb.checked = source.checked; if(source.checked) checkedIds.add(cb.value); else checkedIds.delete(cb.value); }); updateDeleteButton(); }
    function toggleCheckbox(id) { const cb = document.querySelector(`.row-checkbox[value="${id}"]`); if(cb.checked) checkedIds.add(id); else checkedIds.delete(id); updateDeleteButton(); }
    function updateDeleteButton() { const btn = document.getElementById('btn-bulk-delete'); if(checkedIds.size > 0) { btn.classList.remove('hidden'); document.getElementById('selected-count').textContent = checkedIds.size; } else { btn.classList.add('hidden'); } }
    function executeBulkDelete() { if(checkedIds.size === 0) return; showConfirm('ยืนยันลบหมู่', `ต้องการลบข้อมูล ${checkedIds.size} รายการหรือไม่?`, () => { showLoading(`กำลังลบ ${checkedIds.size} รายการ...`); window.dataSdk.deleteBulk(Array.from(checkedIds)).then(res => { setTimeout(() => { hideLoading(); checkedIds.clear(); if(res.isOk) { showAlert('สำเร็จ', 'ลบข้อมูลเรียบร้อยแล้ว'); } else { showAlert('ผิดพลาด', res.error.message); } }, 500); }); }); }

    // RENDER LOGIN (เหมือนเดิม)
    function renderLogin() {
      const config = window.elementSdk?.config || defaultConfig;
      document.getElementById('app').innerHTML = `
        <div class="h-full w-full bg-[#B2B2B2] flex flex-col items-center justify-center p-4 overflow-auto">
          <div class="w-full max-w-md bg-white rounded-[2rem] shadow-xl p-8 relative overflow-hidden shrink-0">
             <div class="absolute -top-10 -right-10 w-32 h-32 bg-yellow-100 rounded-full opacity-50 blur-xl"></div>
             <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-green-100 rounded-full opacity-50 blur-xl"></div>
             <div class="text-center mb-8 relative z-10">
                <div class="mx-auto mb-6"><img src="https://img2.pic.in.th/pic/-69-1.png" alt="โลโก้โรงเรียน" class="h-32 w-auto mx-auto object-contain drop-shadow-md"></div>
                <div class="text-gray-900 font-bold text-lg md:text-xl whitespace-nowrap leading-tight">ระบบประกาศผลคะแนน</div>
                <div class="text-gray-900 font-bold whitespace-nowrap mt-1 leading-tight -mx-6 px-1 text-[13px] min-[360px]:text-[14.5px] min-[390px]:text-[16px] sm:text-xl sm:mx-0">การสอบแข่งขันทักษะวิชาการเพชรราชพฤกษ์</div>
                <p class="text-gray-600 text-xs sm:text-sm font-normal mt-2">โรงเรียนบางสะพานวิทยา จังหวัดประจวบคีรีขันธ์</p>
                <p class="text-gray-400 mt-4 text-sm">ปีการศึกษา <span class="text-lime-600 font-bold">${config.admission_year}</span></p>
             </div>
             <div class="space-y-3 mb-6 relative z-10" id="login-buttons">
                <button type="button" onclick="toggleLogin('student')" class="w-full py-4 px-6 rounded-2xl border-2 border-lime-300 text-lime-700 font-bold hover:bg-lime-50 active:scale-95 transition-all flex items-center justify-center gap-3 shadow-sm">ผู้เข้าสอบ</button>
                <button type="button" onclick="toggleLogin('admin')" class="w-full py-4 px-6 rounded-2xl border-2 border-amber-200 text-amber-500 font-bold hover:bg-amber-50 active:scale-95 transition-all flex items-center justify-center gap-3 shadow-sm">สำหรับแอดมิน</button>
             </div>
             <div id="login-form-container" class="hidden relative z-10 bg-gray-50/80 p-5 rounded-2xl border border-gray-100">
               <form onsubmit="handleLogin(event)" class="space-y-4">
                 <div id="input-student" class="hidden"><label class="block text-xs font-bold text-gray-500 mb-2 uppercase">เลขบัตรประชาชน</label><input type="text" id="login-id" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field" placeholder="กรอกเลขบัตรประชาชน"></div>
                 <div id="input-admin" class="hidden space-y-3">
                    <div><label class="block text-xs font-bold text-gray-500 mb-2 uppercase">ชื่อผู้ใช้</label><input type="text" id="admin-user" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-2 uppercase">รหัสผ่าน</label><input type="password" id="admin-pass" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field"></div>
                 </div>
                 <div class="flex gap-2 pt-2"><button type="button" onclick="resetLogin()" class="px-4 py-3 bg-gray-200 text-gray-600 rounded-xl font-bold text-sm">กลับ</button><button type="submit" class="flex-1 py-3 btn-primary rounded-xl font-bold">เข้าสู่ระบบ</button></div>
               </form>
             </div>
          </div>
          <div class="mt-6 text-center animate-pulse"><p class="text-xs text-white font-medium drop-shadow-md bg-black/10 px-3 py-1 rounded-full">พัฒนาระบบโดย ครูอานนท์ เมืองแก้ว</p></div>
        </div>
      `;
    }

    function toggleLogin(mode) { document.getElementById('login-buttons').classList.add('hidden'); document.getElementById('login-form-container').classList.remove('hidden'); if(mode==='student'){document.getElementById('input-student').classList.remove('hidden');document.getElementById('input-admin').classList.add('hidden');}else{document.getElementById('input-student').classList.add('hidden');document.getElementById('input-admin').classList.remove('hidden');} }
    function resetLogin() { document.getElementById('login-form-container').classList.add('hidden'); document.getElementById('login-buttons').classList.remove('hidden'); }
    function handleLogin(e) { e.preventDefault(); const isStudent = !document.getElementById('input-student').classList.contains('hidden'); if(isStudent){ const id = document.getElementById('login-id').value.trim(); const user = studentsData.find(s => String(s.national_id).trim() === String(id)); if(user){currentUser = user; currentView = 'student'; render();}else showAlert('ไม่พบข้อมูล', 'ไม่พบเลขบัตรประชาชนนี้ในระบบ'); }else{ if(document.getElementById('admin-user').value === 'admin' && document.getElementById('admin-pass').value === 'admin'){currentView='admin';render();}else showAlert('ผิดพลาด', 'ชื่อผู้ใช้หรือรหัสผ่านผิด'); } }

    function renderAdminDashboard() {
      const m1 = studentsData.filter(s => ['p4','p5','p6','m1'].includes(s.grade_level.toLowerCase()));
      const m4 = studentsData.filter(s => ['m3','m4'].includes(s.grade_level.toLowerCase()));
      let active = adminTab === 'm1' ? m1 : m4;
      if(searchQuery) active = active.filter(s => s.full_name.includes(searchQuery) || String(s.exam_id).includes(searchQuery));
      checkedIds.clear();

      document.getElementById('app').innerHTML = `
        <div class="h-full flex flex-col md:flex-row overflow-hidden bg-[#f8fafc]">
          <div class="md:hidden bg-white p-4 shadow-sm flex justify-between items-center z-20 shrink-0 border-b border-gray-100"><div class="flex items-center gap-2"><h2 class="font-bold text-gray-700">ระบบแอดมิน</h2></div><button onclick="toggleSidebar()" class="p-2 text-gray-500">Menu</button></div>
          <div id="sidebar-overlay" class="fixed inset-0 bg-black/30 z-30 hidden md:hidden backdrop-blur-sm" onclick="toggleSidebar()"></div>
          <div id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-white flex flex-col p-6 shadow-2xl transform -translate-x-full transition-transform duration-300 md:translate-x-0 md:static md:shadow-xl sidebar-transition">
             <div class="hidden md:flex mb-10 px-2 items-center gap-3"><h2 class="text-lg font-bold text-gray-700">ระบบแอดมิน</h2></div>
             <div class="space-y-2 flex-1"><button class="sidebar-btn ${adminTab==='m1'?'active':''}" onclick="adminTab='m1';renderAdminDashboard();toggleSidebar()">ม.1</button><button class="sidebar-btn ${adminTab==='m4'?'active':''}" onclick="adminTab='m4';renderAdminDashboard();toggleSidebar()">ม.4</button><button class="sidebar-btn border-t border-gray-100 text-lime-600 mt-4" onclick="showAddStudentForm();toggleSidebar()">+ เพิ่มข้อมูล</button></div>
             <button class="sidebar-btn text-red-400 mt-auto" onclick="currentView='login';render()">ออกจากระบบ</button>
          </div>
          <div class="flex-1 overflow-auto p-4 md:p-10 w-full">
             <div class="flex justify-between items-end mb-6"><div><h1 class="text-2xl font-bold text-gray-800">ข้อมูลผู้สอบ ${adminTab==='m1'?'ม.1':'ม.4'}</h1><p class="text-gray-400 text-sm">ทั้งหมด ${active.length} คน</p></div></div>
             <div class="bg-white p-2 rounded-2xl shadow-sm mb-6 flex gap-2">
                <input type="text" id="search-input" placeholder="ค้นหา..." class="w-full pl-4 pr-4 py-3 rounded-xl border-none bg-gray-50" value="${searchQuery}" onkeydown="if(event.key==='Enter') triggerSearch()"><button onclick="triggerSearch()" class="px-6 bg-lime-400 text-white rounded-xl font-bold">ค้นหา</button>
                <button id="btn-bulk-delete" onclick="executeBulkDelete()" class="hidden px-4 bg-red-400 text-white rounded-xl font-bold">ลบ</button>
             </div>
             
             <div class="bg-white rounded-3xl shadow-sm overflow-hidden border border-gray-100">
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-[800px]">
                       <thead class="bg-lime-50/50 text-lime-800">
                          <tr>
                             <th class="px-4 py-4 w-10 text-center"><input type="checkbox" onchange="toggleAllCheckboxes(this)" class="custom-checkbox rounded text-lime-500"></th>
                             <th class="px-4 py-4 text-sm">รหัส</th>
                             <th class="px-4 py-4 text-sm">ชื่อ</th>
                             <th class="px-4 py-4 text-sm">คะแนนรวม</th>
                             <th class="px-4 py-4 text-sm">ลำดับที่</th>
                             <th class="px-4 py-4 text-sm text-blue-600">ผลการคัดเลือก</th>
                             <th class="px-4 py-4 text-sm text-center">จัดการ</th>
                          </tr>
                       </thead>
                       <tbody class="divide-y divide-gray-50">
                          ${active.map(s => `
                            <tr class="hover:bg-gray-50">
                               <td class="px-4 py-4 text-center"><input type="checkbox" value="${s.__backendId}" onchange="toggleCheckbox('${s.__backendId}')" class="row-checkbox custom-checkbox rounded"></td>
                               <td class="px-4 py-4 font-bold text-lime-600">${s.exam_id}</td>
                               <td class="px-4 py-4 cursor-pointer hover:text-lime-600" onclick="showEditForm('${s.__backendId}')">${s.full_name}</td>
                               <td class="px-4 py-4 font-bold">${s.total_score}</td>
                               <td class="px-4 py-4 text-gray-500">#${s.rank||'-'}</td>
                               <td class="px-4 py-4 font-bold ${s.admission_result ? 'text-green-600' : 'text-gray-300'}">${s.admission_result || '-'}</td>
                               <td class="px-4 py-4 text-center flex justify-center gap-2"><button onclick="showEditForm('${s.__backendId}')" class="text-lime-500">แก้</button><button onclick="deleteStudent('${s.__backendId}')" class="text-red-400">ลบ</button></td>
                            </tr>
                          `).join('')}
                       </tbody>
                    </table>
                </div>
             </div>
          </div>
        </div>
      `;
    }

    function triggerSearch() { searchQuery = document.getElementById('search-input').value.trim(); renderAdminDashboard(); }

    function renderStudentView() {
       if(!currentUser) return;
       
       const maxSci = 40; const maxMath = 30; const maxEng = 30; const maxTotal = 100;
       
       const sSci = parseFloat(currentUser.science_score)||0;
       const sMath = parseFloat(currentUser.math_score)||0;
       const sEng = parseFloat(currentUser.english_score)||0;
       const sTotal = sSci + sMath + sEng;
       
       const pSci = (sSci/maxSci)*100;
       const pMath = (sMath/maxMath)*100;
       const pEng = (sEng/maxEng)*100;

       const thaiGrade = getThaiGrade(currentUser.grade_level);
       
       // ตรวจสอบว่าเป็น ม.3 หรือ ม.4 (เพื่อใช้ Logic ของ ม.ปลาย)
       const isSecondary = ['m3', 'm4'].includes(currentUser.grade_level.toLowerCase());

       document.getElementById('app').innerHTML = `
          <div class="h-full bg-[#fdfbf7] overflow-auto">
             <div class="gradient-bg h-48 w-full absolute top-0 left-0 z-0 rounded-b-[3rem] shadow-lg opacity-90"></div>
             <div class="relative z-10 max-w-4xl mx-auto p-4 pt-8 pb-10">
                
                <div class="flex justify-between items-start mb-6">
                    <div class="flex flex-col">
                        <span class="text-lg md:text-xl font-bold text-lime-900 leading-tight">ประกาศผลคะแนนการสอบ</span>
                        <span class="text-lg md:text-xl font-bold text-lime-900 leading-tight">แข่งขันทักษะวิชาการเพชรราชพฤกษ์</span>
                        <span class="text-lg md:text-xl font-bold text-lime-900 leading-tight">ปีการศึกษา 2569</span>
                        <span class="text-lime-800 font-medium text-sm mt-2">โรงเรียนบางสะพานวิทยา จังหวัดประจวบคีรีขันธ์</span>
                    </div>
                    <button onclick="currentView='login';render()" class="shrink-0 bg-white/80 backdrop-blur-sm text-red-500 hover:bg-red-500 hover:text-white px-4 py-2 rounded-full text-xs font-bold shadow-sm transition-all border border-red-100 ml-2">ออกจากระบบ</button>
                </div>
                
                <div class="bg-white rounded-[2rem] p-6 shadow-xl mb-6 relative overflow-hidden border border-lime-100">
                   <div class="absolute top-0 right-0 w-32 h-32 bg-lime-50 rounded-full -mr-10 -mt-10 opacity-60"></div>
                   
                   <div class="flex flex-col md:flex-row items-center gap-6 relative z-10">
                        <div class="flex-1 text-center md:text-left w-full">
                            <h2 class="text-2xl font-bold text-gray-800 mb-1">${currentUser.full_name}</h2>
                            <p class="text-lime-600 font-medium mb-4 text-sm">${thaiGrade}</p>
                            
                            ${currentUser.admission_result 
                                ? `<div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-xl text-center"><p class="text-green-800 font-bold text-lg">ขอแสดงความยินดี</p><p class="text-green-600">ผ่านการคัดเลือกเข้าศึกษาต่อโครงการ <span class="font-bold text-xl block mt-1">${currentUser.admission_result}</span></p></div>` 
                                : `<div class="mb-4 p-4 bg-gray-50 border border-gray-200 rounded-xl text-center"><p class="text-gray-500">ยังไม่ผ่านเกณฑ์การคัดเลือกในรอบโควตา</p></div>`
                            }

                            <div class="grid grid-cols-1 gap-3 text-gray-600 text-sm mb-4">
                                <div class="bg-gray-50 px-4 py-3 rounded-xl border border-gray-100 flex justify-between"><span>เลขประจำตัวสอบ</span><span class="font-bold text-gray-800">${currentUser.exam_id}</span></div>
                                <div class="bg-gray-50 px-4 py-3 rounded-xl border border-gray-100 flex justify-between"><span>ลำดับที่ (คะแนนรวม)</span><span class="font-bold text-blue-600">#${currentUser.rank}</span></div>
                            </div>

                            <div class="border-t border-gray-100 pt-4">
                                <p class="text-xs text-gray-400 font-bold mb-2 text-left">ลำดับการเลือกห้องเรียนโครงการ</p>
                                
                                <div class="grid ${isSecondary ? 'grid-cols-2' : 'grid-cols-3'} gap-2">
                                    <div class="bg-blue-50/50 border border-blue-100 p-2 rounded-lg text-center">
                                        <span class="block text-[10px] text-blue-400 font-bold uppercase">อันดับ 1</span>
                                        <span class="text-sm font-bold text-gray-700 truncate block">${currentUser.choice_1 || '-'}</span>
                                    </div>
                                    <div class="bg-blue-50/50 border border-blue-100 p-2 rounded-lg text-center">
                                        <span class="block text-[10px] text-blue-400 font-bold uppercase">อันดับ 2</span>
                                        <span class="text-sm font-bold text-gray-700 truncate block">${currentUser.choice_2 || '-'}</span>
                                    </div>
                                    
                                    ${!isSecondary ? `
                                    <div class="bg-blue-50/50 border border-blue-100 p-2 rounded-lg text-center">
                                        <span class="block text-[10px] text-blue-400 font-bold uppercase">อันดับ 3</span>
                                        <span class="text-sm font-bold text-gray-700 truncate block">${currentUser.choice_3 || '-'}</span>
                                    </div>` : ''}
                                </div>
                            </div>

                        </div>
                   </div>
                </div>
                
                <h3 class="text-gray-600 font-bold text-lg mb-4 ml-2 flex items-center gap-2">คะแนนรายวิชา</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                   <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-2 relative overflow-hidden group hover:shadow-md transition-shadow">
                        <div class="absolute right-0 top-0 w-16 h-16 bg-blue-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                        <div class="flex justify-between items-center mb-1 relative z-10"><span class="text-gray-600 text-xs font-bold uppercase tracking-wider">วิทยาศาสตร์</span><span class="text-[10px] text-gray-400 font-bold bg-gray-50 px-2 py-0.5 rounded-full border border-gray-100">เต็ม ${maxSci}</span></div>
                        <div class="flex justify-between items-end relative z-10"><span class="text-3xl font-bold text-gray-800">${sSci}</span><span class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-lg">ร้อยละ ${pSci.toFixed(1)}</span></div>
                        <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden mt-3 relative z-10"><div class="bg-blue-400 h-2 rounded-full" style="width: ${pSci}%"></div></div>
                   </div>
                   <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-2 relative overflow-hidden group hover:shadow-md transition-shadow">
                        <div class="absolute right-0 top-0 w-16 h-16 bg-red-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                        <div class="flex justify-between items-center mb-1 relative z-10"><span class="text-gray-600 text-xs font-bold uppercase tracking-wider">คณิตศาสตร์</span><span class="text-[10px] text-gray-400 font-bold bg-gray-50 px-2 py-0.5 rounded-full border border-gray-100">เต็ม ${maxMath}</span></div>
                        <div class="flex justify-between items-end relative z-10"><span class="text-3xl font-bold text-gray-800">${sMath}</span><span class="text-[10px] font-bold text-red-600 bg-red-50 px-2 py-1 rounded-lg">ร้อยละ ${pMath.toFixed(1)}</span></div>
                        <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden mt-3 relative z-10"><div class="bg-red-400 h-2 rounded-full" style="width: ${pMath}%"></div></div>
                   </div>
                   <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-2 relative overflow-hidden group hover:shadow-md transition-shadow">
                        <div class="absolute right-0 top-0 w-16 h-16 bg-purple-50 rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                        <div class="flex justify-between items-center mb-1 relative z-10"><span class="text-gray-600 text-xs font-bold uppercase tracking-wider">ภาษาอังกฤษ</span><span class="text-[10px] text-gray-400 font-bold bg-gray-50 px-2 py-0.5 rounded-full border border-gray-100">เต็ม ${maxEng}</span></div>
                        <div class="flex justify-between items-end relative z-10"><span class="text-3xl font-bold text-gray-800">${sEng}</span><span class="text-[10px] font-bold text-purple-600 bg-purple-50 px-2 py-1 rounded-lg">ร้อยละ ${pEng.toFixed(1)}</span></div>
                        <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden mt-3 relative z-10"><div class="bg-purple-400 h-2 rounded-full" style="width: ${pEng}%"></div></div>
                   </div>
                </div>

                 <div class="bg-gradient-to-br from-amber-50 via-orange-50 to-white rounded-3xl p-6 border border-amber-100 text-center relative overflow-hidden shadow-sm">
                    <div class="absolute top-0 left-0 w-full h-full bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9IiNmYmJmMjQiIGZpbGwtb3BhY2l0eT0iMC4yIi8+PC9zdmc+')] opacity-30"></div>
                    <div class="relative z-10 flex flex-col items-center">
                        <p class="text-amber-700 font-bold uppercase tracking-widest text-xs mb-2">คะแนนรวม 3 วิชา (เต็ม ${maxTotal})</p>
                        <div class="flex items-baseline gap-2"><p class="text-5xl font-black text-amber-500 drop-shadow-sm tracking-tight">${sTotal.toFixed(2)}</p></div>
                        <span class="text-xs font-bold text-amber-700 bg-amber-100/50 px-4 py-1.5 rounded-full mt-3 border border-amber-200">คิดเป็นร้อยละ ${((sTotal/maxTotal)*100).toFixed(1)}</span>
                    </div>
                 </div>
                 
                 <div class="mt-8 mb-4 text-center border-t border-gray-200/50 pt-4">
                    <p class="text-xs text-gray-400 font-medium">พัฒนาระบบโดย ครูอานนท์ เมืองแก้ว</p>
                 </div>
             </div>
          </div>
       `;
    }

    function switchAddTab(tabName) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(`tab-${tabName}`).classList.add('active'); ['single','multiple','excel','score'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden')); document.getElementById(`view-${tabName}`).classList.remove('hidden'); if(tabName==='multiple') { document.getElementById('multiple-tbody').innerHTML=''; addMultipleRow(); } }
    function showAddStudentForm() { formMode = 'create'; document.getElementById('student-form').reset(); document.getElementById('add-mode-tabs').classList.remove('hidden'); document.getElementById('score-section').classList.add('hidden'); switchAddTab('single'); openModal(); }
    function showEditForm(id) { 
        formMode = 'update'; document.getElementById('add-mode-tabs').classList.add('hidden'); ['single','multiple','excel','score'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden')); document.getElementById('view-single').classList.remove('hidden'); document.getElementById('score-section').classList.remove('hidden'); 
        const s = studentsData.find(x => x.__backendId === id); if(!s) return; 
        document.getElementById('student-backend-id').value = s.__backendId; document.getElementById('form-national-id').value = s.national_id || ''; document.getElementById('form-exam-id').value = s.exam_id; document.getElementById('form-grade').value = s.grade_level; document.getElementById('form-name').value = s.full_name; document.getElementById('form-school').value = s.previous_school; 
        document.getElementById('score-science').value = s.science_score; document.getElementById('score-math').value = s.math_score; document.getElementById('score-english').value = s.english_score; 
        
        // Update Options first
        updateChoiceOptions();
        // Set values after options are populated
        setTimeout(() => {
            document.getElementById('form-choice-1').value = s.choice_1;
            document.getElementById('form-choice-2').value = s.choice_2;
            document.getElementById('form-choice-3').value = s.choice_3;
        }, 50);
        openModal(); 
    }
    
    function handleSingleSubmit(e) { 
        e.preventDefault(); 
        const scores = [0, parseFloat(document.getElementById('score-math').value)||0, parseFloat(document.getElementById('score-science').value)||0, parseFloat(document.getElementById('score-english').value)||0, 0]; 
        const data = { 
            exam_id: document.getElementById('form-exam-id').value, national_id: document.getElementById('form-national-id').value, grade_level: document.getElementById('form-grade').value, full_name: document.getElementById('form-name').value, previous_school: document.getElementById('form-school').value, 
            thai_score: scores[0], math_score: scores[1], science_score: scores[2], english_score: scores[3], aptitude_score: scores[4], total_score: scores.reduce((a,b)=>a+b,0),
            choice_1: document.getElementById('form-choice-1').value, choice_2: document.getElementById('form-choice-2').value, choice_3: document.getElementById('form-choice-3').value, admission_result: ''
        }; 
        showLoading('กำลังบันทึก...'); const action = formMode === 'create' ? window.dataSdk.create(data) : (data.__backendId = document.getElementById('student-backend-id').value, window.dataSdk.update(data)); action.then(res => { setTimeout(() => { hideLoading(); if(res.isOk) { closeModal(); showAlert('สำเร็จ', 'บันทึกเรียบร้อย'); } else { showAlert('ผิดพลาด', res.error.message); } }, 500); }); 
    }
    
    function addMultipleRow() { const tr = document.createElement('tr'); tr.className = 'bg-white border-b hover:bg-gray-50'; tr.innerHTML = `<td class="p-2"><input type="text" class="w-full border rounded px-2 py-1 multi-national-id text-xs" placeholder="บัตรฯ"></td><td class="p-2"><input type="text" class="w-full border rounded px-2 py-1 multi-exam-id text-xs" placeholder="รหัส"></td><td class="p-2"><input type="text" class="w-full border rounded px-2 py-1 multi-name text-xs" placeholder="ชื่อ"></td><td class="p-2"><select class="w-full border rounded px-2 py-1 multi-grade text-xs"><option value="p6">ป.6</option><option value="p5">ป.5</option><option value="p4">ป.4</option><option value="m3">ม.3</option></select></td><td class="p-2"><input type="text" class="w-full border rounded px-2 py-1 multi-school text-xs" placeholder="รร."></td><td class="p-2 text-center"><button type="button" onclick="this.closest('tr').remove()" class="text-red-500 font-bold">x</button></td>`; document.getElementById('multiple-tbody').appendChild(tr); }
    function handleMultipleSubmit() { const rows = document.querySelectorAll('#multiple-tbody tr'); const bulkData = []; rows.forEach(row => { const nid = row.querySelector('.multi-national-id').value.trim(); const id = row.querySelector('.multi-exam-id').value.trim(); const name = row.querySelector('.multi-name').value.trim(); if(id && name) bulkData.push({ exam_id: id, national_id: nid, full_name: name, grade_level: row.querySelector('.multi-grade').value, previous_school: row.querySelector('.multi-school').value.trim(), thai_score:0, math_score:0, science_score:0, english_score:0, aptitude_score:0, total_score:0, rank:0, choice_1:'', choice_2:'', choice_3:'', admission_result:'' }); }); if(bulkData.length === 0) return showAlert('แจ้งเตือน', 'กรุณากรอกข้อมูลอย่างน้อย 1 รายการ'); showConfirm('ยืนยัน', `เพิ่ม ${bulkData.length} รายการ?`, () => { showLoading('กำลังบันทึก...'); window.dataSdk.createBulk(bulkData).then(res => { setTimeout(() => { hideLoading(); if(res.isOk) { closeModal(); showAlert('สำเร็จ', 'บันทึกเรียบร้อย'); } else { showAlert('ผิดพลาด', res.error.message); } }, 500); }); }); }
    
    function handleExcelUpload(input, type) { 
        if(!input.files[0]) return; const reader = new FileReader(); 
        reader.onload = (e) => { 
            const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'}); 
            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1, raw: false, defval: ""}); 
            if(type === 'student') { 
                excelDataCache = []; 
                for(let i=1; i<jsonData.length; i++) { 
                    const row = jsonData[i]; 
                    if(row[0] && row[2]) excelDataCache.push({ 
                        exam_id: String(row[0]), national_id: String(row[1]||''), full_name: String(row[2]), grade_level: String(row[3]||'m3').toLowerCase(), previous_school: String(row[4]||''), 
                        choice_1: String(row[5]||''), choice_2: String(row[6]||''), choice_3: String(row[7]||''), 
                        thai_score:0, math_score:0, science_score:0, english_score:0, aptitude_score:0, total_score:0, rank:0, admission_result:'' 
                    }); 
                } 
                document.getElementById('excel-count').textContent = excelDataCache.length; document.getElementById('excel-preview-area').classList.remove('hidden'); document.getElementById('excel-preview-table').innerHTML = `<thead><tr class="bg-gray-100"><th>รหัส</th><th>ชื่อ</th><th>เลือก 1</th></tr></thead><tbody>` + excelDataCache.slice(0,5).map(p=>`<tr><td>${p.exam_id}</td><td>${p.full_name}</td><td>${p.choice_1}</td></tr>`).join('') + `</tbody>`; 
            } else if(type === 'score') { 
                scoreDataCache = []; for(let i=1; i<jsonData.length; i++) { const row = jsonData[i]; if(row[0]) scoreDataCache.push({ exam_id: String(row[0]), science_score: row[1]||0, math_score: row[2]||0, english_score: row[3]||0 }); } 
                document.getElementById('score-count').textContent = scoreDataCache.length; document.getElementById('score-preview-area').classList.remove('hidden'); document.getElementById('score-preview-table').innerHTML = `<thead><tr class="bg-gray-100"><th>รหัส</th><th>วิทย์</th><th>คณิต</th><th>อังกฤษ</th></tr></thead><tbody>` + scoreDataCache.slice(0,5).map(p=>`<tr><td>${p.exam_id}</td><td>${p.science_score}</td><td>${p.math_score}</td><td>${p.english_score}</td></tr>`).join('') + `</tbody>`; 
            } 
        }; reader.readAsArrayBuffer(input.files[0]); 
    }
    
    function confirmExcelImport(type) { if(type === 'student' && excelDataCache.length > 0) { showConfirm('ยืนยัน', `นำเข้า ${excelDataCache.length} รายการ?`, () => { showLoading('กำลังนำเข้า...'); window.dataSdk.createBulk(excelDataCache).then(res => { setTimeout(() => { hideLoading(); if(res.isOk) { closeModal(); showAlert('สำเร็จ', 'เรียบร้อย'); } else { showAlert('ผิดพลาด', res.error.message); } }, 500); }); }); } else if(type === 'score' && scoreDataCache.length > 0) { showConfirm('ยืนยัน', `อัปเดตคะแนน ${scoreDataCache.length} รายการ?`, () => { showLoading('กำลังอัปเดตคะแนน...'); window.dataSdk.updateScoresBulk(scoreDataCache).then(res => { setTimeout(() => { hideLoading(); if(res.isOk) { closeModal(); showAlert('สำเร็จ', res.message); } else { showAlert('ผิดพลาด', res.error.message); } }, 500); }); }); } }
    function deleteStudent(id) { showConfirm('ยืนยันลบ', 'ลบข้อมูลนี้หรือไม่?', () => { showLoading('กำลังลบ...'); window.dataSdk.delete({__backendId: id}).then(res => { setTimeout(() => { hideLoading(); if(res.isOk) showAlert('สำเร็จ', 'ลบเรียบร้อย'); else showAlert('ผิดพลาด', res.error.message); }, 500); }); }); }
    
    window.addEventListener('load', () => { window.dataSdk.init(dataHandler); render(); });
  </script>
 </body>
</html>
