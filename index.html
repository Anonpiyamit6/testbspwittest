<!doctype html>
<html lang="th" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ระบบประกาศผลคะแนน</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">

<style>
body { box-sizing: border-box; font-family: 'Sarabun', sans-serif; background-color: #f0fdf4; color: #4b5563; -webkit-tap-highlight-color: transparent; }
.gradient-bg { background-color: #C6E686; } 
.btn-primary { background: linear-gradient(135deg, #fcd34d 0%, #fbbf24 100%); color: #78350f; transition: all 0.2s ease; cursor: pointer; }
.btn-primary:active { transform: scale(0.96); }
.card-hover { background-color: white; transition: all 0.3s ease; border: 1px solid #e5e7eb; }
.input-field { background-color: #f9fafb; border: 1px solid #e5e7eb; transition: all 0.2s ease; }
.input-field:focus { background-color: white; border-color: #C6E686; box-shadow: 0 0 0 3px rgba(198, 230, 134, 0.4); outline: none; }
.sidebar-btn { width: 100%; text-align: left; padding: 12px 16px; margin-bottom: 8px; border-radius: 12px; display: flex; align-items: center; gap: 12px; color: #4b5563; background: transparent; border: none; cursor: pointer; min-height: 48px; }
.sidebar-btn:active { background-color: #ecfdf5; }
.sidebar-btn.active { background-color: #eefad2; color: #5a7a1a; font-weight: 600; }
@media (hover: hover) { .sidebar-btn:hover { background-color: #f7fee7; color: #5a7a1a; } .card-hover:hover { transform: translateY(-3px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border-color: #C6E686; } .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4); } }
.clickable-name { cursor: pointer; font-weight: 600; color: #65a30d; text-decoration: underline; text-underline-offset: 2px; }
.modal-overlay { background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(8px); }
#student-modal { transition: opacity 0.2s ease; z-index: 100; } 
body.modal-active { overflow: hidden !important; }
#alert-modal, #confirm-modal, #loading-modal { z-index: 200; transition: opacity 0.2s ease; }
.hidden-force { display: none !important; }
.tab-btn { border-bottom: 3px solid transparent; color: #9ca3af; padding: 12px 16px; transition: all 0.2s; white-space: nowrap; cursor: pointer; }
.tab-btn.active { border-bottom: 3px solid #84cc16; color: #4d7c0f; font-weight: bold; background-color: #f7fee7; }
</style>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxjl2-P7ia1wsrY_ptExFJWUWI4VUU8GKL9-XYujPSt-0TNAuEXNRw-VLibzq9cH0o/exec"

async function callApi(action, data = {}) {
const body = JSON.stringify({ action, ...data });
const response = await fetch(API_URL, {
method: 'POST',
body: body,
headers: { "Content-Type": "text/plain;charset=utf-8" } 
});
return await response.json();
}

window.dataSdk = {
init: async (handler) => { window.dataSdkHandler = handler; await window.dataSdk.refresh(); return { isOk: true }; },
refresh: async () => { 
try {
const res = await callApi('getAllStudents');
if (res.success) { 
const mappedData = res.students.map(s => ({ ...s, __backendId: s.id })); 
if (window.dataSdkHandler?.onDataChanged) window.dataSdkHandler.onDataChanged(mappedData); 
return { isOk: true, data: mappedData }; 
} 
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
},
create: async (data) => {
try {
const res = await callApi('createStudent', { data });
if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; }
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
},
createBulk: async (dataArray) => {
try {
const res = await callApi('createStudentsBulk', { data: dataArray });
if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; }
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
},
updateScoresBulk: async (dataArray) => {
try {
const res = await callApi('updateScoresBulk', { data: dataArray });
if(res.success) { await window.dataSdk.refresh(); return { isOk: true, message: res.message }; }
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
},
update: async (data) => {
try {
const updateData = { ...data, id: data.__backendId };
const res = await callApi('updateStudent', { data: updateData });
if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; }
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
},
delete: async (data) => {
try {
const res = await callApi('deleteStudent', { id: data.__backendId });
if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; }
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
},
deleteBulk: async (ids) => {
try {
const res = await callApi('deleteStudentsBulk', { ids });
if(res.success) { await window.dataSdk.refresh(); return { isOk: true }; }
return { isOk: false, error: { message: res.message } };
} catch(e) { return { isOk: false, error: { message: e.message } }; }
}
};
</script>
</head>
<body class="h-full">
<div id="app" class="h-full w-full"></div>

<div id="student-modal" class="hidden-force fixed inset-0 flex items-center justify-center z-[100]">
<div class="modal-overlay absolute w-full h-full" onclick="closeModal()"></div>
<div class="bg-white w-full h-full md:w-11/12 md:h-auto md:max-w-4xl md:max-h-[90vh] md:rounded-[2rem] shadow-2xl z-[101] flex flex-col border border-lime-100 relative transform transition-all">
<div class="flex justify-between items-center px-6 py-4 bg-gradient-to-r from-lime-50 to-white border-b border-lime-100 shrink-0">
<div class="flex items-center gap-3"><div class="p-2 bg-lime-100 rounded-full text-lime-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></div><p class="text-lg md:text-xl font-bold text-lime-800" id="modal-title">จัดการข้อมูล</p></div>
<button type="button" class="text-gray-400 hover:text-red-500 p-2 rounded-full active:bg-gray-100" onclick="closeModal()"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
</div>

<div id="add-mode-tabs" class="flex px-4 border-b border-gray-100 bg-gray-50/50 hidden overflow-x-auto shrink-0">
<button type="button" onclick="switchAddTab('single')" id="tab-single" class="tab-btn active flex-1 md:flex-none">เพิ่มทีละคน</button>
<button type="button" onclick="switchAddTab('multiple')" id="tab-multiple" class="tab-btn flex-1 md:flex-none">เพิ่มหลายคน</button>
<button type="button" onclick="switchAddTab('excel')" id="tab-excel" class="tab-btn flex-1 md:flex-none">Import ชื่อ</button>
<button type="button" onclick="switchAddTab('score')" id="tab-score" class="tab-btn flex-1 md:flex-none text-purple-600 font-bold">Import คะแนน</button>
</div>

<div class="overflow-y-auto p-4 md:p-8 flex-1 bg-white">
<div id="view-single" class="block pb-20 md:pb-0">
<form id="student-form" onsubmit="handleSingleSubmit(event)">
<input type="hidden" id="student-backend-id">
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6">
<div><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">เลขบัตรประชาชน (13 หลัก)</label><input type="text" id="form-national-id" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field" placeholder="00xxxxxxxxxxx" required></div>
<div><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">รหัสประจำตัวสอบ</label><input type="text" id="form-exam-id" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field" required></div>
<div><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">ระดับชั้น</label><select id="form-grade" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field bg-white"><option value="p4">ประถมศึกษาปีที่ 4</option><option value="p5">ประถมศึกษาปีที่ 5</option><option value="p6">ประถมศึกษาปีที่ 6</option><option value="m3">มัธยมศึกษาปีที่ 3</option></select></div>
<div><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">ชื่อ-นามสกุล</label><input type="text" id="form-name" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field" required></div>
<div class="md:col-span-2"><label class="block text-gray-500 text-xs font-bold mb-2 uppercase">โรงเรียนปัจจุบัน</label><input type="text" id="form-school" class="w-full px-4 py-3 rounded-xl border-gray-200 input-field"></div>
</div>
<div id="score-section" class="bg-amber-50/50 p-4 md:p-6 rounded-2xl border border-amber-100">
<h3 class="text-sm font-bold text-amber-600 mb-4 uppercase">คะแนนสอบ</h3>
<div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4">
<div><label class="text-xs text-gray-500 font-semibold">วิทยาศาสตร์ (40)</label><input type="number" step="0.01" id="score-science" class="w-full px-3 py-2 rounded-lg border-gray-200 text-center font-bold text-lime-600 input-field"></div>
<div><label class="text-xs text-gray-500 font-semibold">คณิตศาสตร์ (30)</label><input type="number" step="0.01" id="score-math" class="w-full px-3 py-2 rounded-lg border-gray-200 text-center font-bold text-lime-600 input-field"></div>
<div><label class="text-xs text-gray-500 font-semibold">ภาษาอังกฤษ (30)</label><input type="number" step="0.01" id="score-english" class="w-full px-3 py-2 rounded-lg border-gray-200 text-center font-bold text-lime-600 input-field"></div>
</div>
</div>
<div class="flex justify-end pt-6 gap-3 md:relative fixed bottom-0 left-0 w-full bg-white p-4 border-t border-gray-100 md:border-0 md:bg-transparent md:p-0 z-10">
<button type="button" onclick="closeModal()" class="flex-1 md:flex-none px-6 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">ยกเลิก</button>
<button type="submit" class="flex-1 md:flex-none px-8 py-3 btn-primary rounded-xl font-bold">บันทึก</button>
</div>
</form>
</div>

<div id="view-multiple" class="hidden h-full flex flex-col">
<div class="flex-1 overflow-auto border border-gray-100 rounded-xl mb-4 shadow-inner bg-gray-50/50">
<table class="w-full text-sm text-left text-gray-500" id="multiple-table"><thead class="text-xs text-gray-500 uppercase bg-gray-100 sticky top-0"><tr><th class="px-2 py-3">เลขบัตร</th><th class="px-2 py-3">รหัส</th><th class="px-2 py-3">ชื่อ</th><th class="px-2 py-3">ชั้น</th><th class="px-2 py-3">รร.</th><th class="px-1 py-3">ลบ</th></tr></thead><tbody id="multiple-tbody" class="bg-white"></tbody></table>
</div>
<div class="flex justify-between items-center bg-white p-2 rounded-lg gap-2">
<button type="button" onclick="addMultipleRow()" class="flex-1 text-lime-600 font-bold bg-lime-50 px-3 py-3 rounded-lg">+ เพิ่มแถว</button>
<button type="button" onclick="handleMultipleSubmit()" class="flex-1 btn-primary px-3 py-3 rounded-lg font-bold shadow-md">บันทึก</button>
</div>
</div>

<div id="view-excel" class="hidden">
<div class="border-2 border-dashed border-lime-200 bg-lime-50/30 rounded-2xl p-6 md:p-10 text-center cursor-pointer">
<label for="excel-upload-name" class="cursor-pointer block"><span class="block text-lg font-bold text-lime-700">เลือกไฟล์ Excel (รายชื่อ)</span><input id="excel-upload-name" type="file" class="hidden" accept=".xlsx, .xls" onchange="handleExcelUpload(this, 'student')"></label>
</div>
<div class="mt-6 bg-amber-50 p-6 rounded-2xl border border-amber-100"><h4 class="font-bold text-amber-700 mb-2">คำแนะนำไฟล์</h4><ul class="text-sm text-amber-800 space-y-1 ml-7 list-disc"><li>A: รหัสสอบ</li><li>B: เลขบัตรฯ</li><li>C: ชื่อ-นามสกุล</li><li>D: ชั้น</li><li>E: รร.ปัจจุบัน</li></ul></div>
<div id="excel-preview-area" class="mt-6 hidden">
<div class="flex justify-between items-center mb-3"><h4 class="font-bold text-gray-700 text-sm">Preview (<span id="excel-count">0</span>)</h4><button type="button" onclick="confirmExcelImport('student')" class="px-4 py-2 btn-primary rounded-lg font-bold text-sm">ยืนยัน</button></div>
<div class="overflow-auto max-h-48 border border-gray-200 rounded-xl text-xs bg-white"><table class="w-full text-left" id="excel-preview-table"></table></div>
</div>
</div>

<div id="view-score" class="hidden">
<div class="border-2 border-dashed border-purple-200 bg-purple-50/30 rounded-2xl p-6 md:p-10 text-center cursor-pointer">
<label for="excel-upload-score" class="cursor-pointer block"><span class="block text-lg font-bold text-purple-700">เลือกไฟล์ Excel (คะแนน)</span><input id="excel-upload-score" type="file" class="hidden" accept=".xlsx, .xls" onchange="handleExcelUpload(this, 'score')"></label>
</div>
<div class="mt-6 bg-purple-50 p-6 rounded-2xl border border-purple-100"><h4 class="font-bold text-purple-700 mb-2">คำแนะนำคะแนน</h4><ul class="text-sm text-purple-800 space-y-1 ml-7 list-disc"><li>A: รหัสสอบ</li><li>B: วิทย์</li><li>C: คณิต</li><li>D: อังกฤษ</li></ul></div>
<div id="score-preview-area" class="mt-6 hidden">
<div class="flex justify-between items-center mb-3"><h4 class="font-bold text-gray-700 text-sm">Preview (<span id="score-count">0</span>)</h4><button type="button" onclick="confirmExcelImport('score')" class="px-4 py-2 bg-purple-500 text-white rounded-lg font-bold text-sm">อัปเดต</button></div>
<div class="overflow-auto max-h-48 border border-gray-200 rounded-xl text-xs bg-white"><table class="w-full text-left" id="score-preview-table"></table></div>
</div>
</div>
</div>
</div>
</div>

<div id="alert-modal" class="hidden-force fixed inset-0 flex items-center justify-center px-4"><div class="modal-overlay absolute w-full h-full" onclick="closeAlert()"></div><div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-6 text-center relative border border-lime-50 animate-bounce-in"><h3 class="text-lg font-bold text-gray-800 mb-2" id="alert-title">แจ้งเตือน</h3><p class="text-gray-500 mb-6 text-sm" id="alert-message"></p><button onclick="closeAlert()" class="w-full py-3 bg-lime-400 text-white rounded-xl font-bold">ตกลง</button></div></div>
<div id="confirm-modal" class="hidden-force fixed inset-0 flex items-center justify-center px-4"><div class="modal-overlay absolute w-full h-full" onclick="closeConfirm()"></div><div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-6 text-center relative border border-amber-50"><h3 class="text-lg font-bold text-gray-800 mb-2" id="confirm-title">ยืนยัน</h3><p class="text-gray-500 mb-6 text-sm" id="confirm-message"></p><div class="flex gap-3"><button onclick="closeConfirm()" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold">ยกเลิก</button><button onclick="confirmAction()" class="flex-1 py-3 bg-amber-400 text-white rounded-xl font-bold">ยืนยัน</button></div></div></div>
<div id="loading-modal" class="hidden-force fixed inset-0 flex items-center justify-center"><div class="modal-overlay absolute w-full h-full bg-white/80 backdrop-blur-sm"></div><div class="bg-white rounded-3xl p-6 w-48 text-center relative border border-lime-50"><div class="mx-auto w-12 h-12 border-4 border-lime-100 border-t-lime-500 rounded-full animate-spin mb-3"></div><p class="text-lime-600 font-bold text-sm" id="loading-message">โหลด...</p></div></div>

<script>
const defaultConfig = { 
system_title: "ระบบประกาศผลคะแนน<br>การสอบแข่งขันทักษะวิชาการเพชรราชพฤกษ์<br><span class='text-sm font-normal'>โรงเรียนบางสะพานวิทยา จังหวัดประจวบคีรีขันธ์</span>", 
admission_year: "2569" 
};

let currentUser = null, currentView = 'login', adminTab = 'm1', studentsData = [], searchQuery = '', formMode = 'create', excelDataCache = [], scoreDataCache = [], confirmCallback = null, isSidebarOpen = false, checkedIds = new Set();

function getThaiGrade(code) { const map = { 'p4': 'ประถมศึกษาปีที่ 4', 'p5': 'ประถมศึกษาปีที่ 5', 'p6': 'ประถมศึกษาปีที่ 6', 'm3': 'มัธยมศึกษาปีที่ 3' }; return map[code.toLowerCase()] || code; }
function toggleSidebar() { const sb=document.getElementById('sidebar'), ov=document.getElementById('sidebar-overlay'); isSidebarOpen=!isSidebarOpen; if(isSidebarOpen){sb.classList.remove('-translate-x-full');ov.classList.remove('hidden');}else{sb.classList.add('-translate-x-full');ov.classList.add('hidden');} }

function showAlert(t, m) { document.getElementById('alert-title').textContent = t; document.getElementById('alert-message').textContent = m; document.getElementById('alert-modal').classList.remove('hidden-force'); }
function closeAlert() { document.getElementById('alert-modal').classList.add('hidden-force'); }
function showConfirm(t, m, cb) { document.getElementById('confirm-title').textContent = t; document.getElementById('confirm-message').textContent = m; confirmCallback = cb; document.getElementById('confirm-modal').classList.remove('hidden-force'); }
function closeConfirm() { document.getElementById('confirm-modal').classList.add('hidden-force'); confirmCallback = null; }
function confirmAction() { if(confirmCallback) confirmCallback(); closeConfirm(); }
function showLoading(msg) { document.getElementById('loading-message').textContent = msg; document.getElementById('loading-modal').classList.remove('hidden-force'); }
function hideLoading() { document.getElementById('loading-modal').classList.add('hidden-force'); }
function openModal() { document.getElementById('student-modal').classList.remove('hidden-force'); document.body.classList.add('modal-active'); }
function closeModal() { document.getElementById('student-modal').classList.add('hidden-force'); document.body.classList.remove('modal-active'); }

const dataHandler = { onDataChanged(data) { studentsData = data.sort((a, b) => b.total_score - a.total_score); let m1 = studentsData.filter(s => ['p4','p5','p6','m1'].includes(s.grade_level)); let m4 = studentsData.filter(s => ['m3','m4'].includes(s.grade_level)); m1.forEach((s, i) => s.rank = i+1); m4.forEach((s, i) => s.rank = i+1); if (currentView === 'admin') renderAdminDashboard(); else if (currentView === 'student' && currentUser) { const u = studentsData.find(s => String(s.national_id) === String(currentUser.national_id)); if(u) currentUser = u; renderStudentView(); } } };
function render() { if(currentView === 'login') renderLogin(); else if(currentView === 'admin') renderAdminDashboard(); else renderStudentView(); }

function toggleAllCheckboxes(source) { const checkboxes = document.querySelectorAll('.row-checkbox'); checkboxes.forEach(cb => { cb.checked = source.checked; if(source.checked) checkedIds.add(cb.value); else checkedIds.delete(cb.value); }); updateDeleteButton(); }
function toggleCheckbox(id) { const cb = document.querySelector(`.row-checkbox[value="${id}"]`); if(cb.checked) checkedIds.add(id); else checkedIds.delete(id); updateDeleteButton(); }
function updateDeleteButton() { const btn = document.getElementById('btn-bulk-delete'); if(checkedIds.size > 0) { btn.classList.remove('hidden'); document.getElementById('selected-count').textContent = checkedIds.size; } else { btn.classList.add('hidden'); } }
function executeBulkDelete() { if(checkedIds.size === 0) return; showConfirm('ยืนยันลบหมู่', `ต้องการลบ ${checkedIds.size} รายการ?`, () => { showLoading(`ลบ ${checkedIds.size} รายการ...`); window.dataSdk.deleteBulk(Array.from(checkedIds)).then(res => { setTimeout(() => { hideLoading(); checkedIds.clear(); if(res.isOk) showAlert('สำเร็จ', 'ลบเรียบร้อย'); else showAlert('ผิดพลาด', res.error.message); }, 500); }); }); }

function renderLogin() {
document.getElementById('app').innerHTML = `
<div class="h-full w-full bg-[#B2B2B2] flex flex-col items-center justify-center p-4 overflow-auto">
<div class="w-full max-w-md bg-white rounded-[2rem] shadow-xl p-8 relative overflow-hidden">
<div class="text-center mb-8 relative z-10">
<img src="https://img2.pic.in.th/pic/-69-1.png" class="h-32 mx-auto mb-6">
<div class="text-gray-900 font-bold text-lg leading-tight">ระบบประกาศผลคะแนน</div>
<div class="text-gray-900 font-bold mt-1 leading-tight text-[14px] sm:text-xl">การสอบแข่งขันทักษะวิชาการเพชรราชพฤกษ์</div>
<p class="text-gray-600 text-xs sm:text-sm mt-2">โรงเรียนบางสะพานวิทยา จังหวัดประจวบคีรีขันธ์</p>
<p class="text-gray-400 mt-4 text-sm">ปีการศึกษา <span class="text-lime-600 font-bold">${defaultConfig.admission_year}</span></p>
</div>
<div class="space-y-3 mb-6 relative z-10" id="login-buttons">
<button onclick="toggleLogin('student')" class="w-full py-4 border-2 border-lime-300 text-lime-700 font-bold rounded-2xl">ผู้เข้าสอบ</button>
<button onclick="toggleLogin('admin')" class="w-full py-4 border-2 border-amber-200 text-amber-500 font-bold rounded-2xl">สำหรับแอดมิน</button>
</div>
<div id="login-form-container" class="hidden relative z-10 bg-gray-50/80 p-5 rounded-2xl border">
<form onsubmit="handleLogin(event)" class="space-y-4">
<div id="input-student" class="hidden"><label class="text-xs font-bold text-gray-500 uppercase">บัตรประชาชน</label><input type="text" id="login-id" class="w-full p-4 rounded-xl border input-field"></div>
<div id="input-admin" class="hidden space-y-3">
<div><label class="text-xs font-bold text-gray-500 uppercase">User</label><input type="text" id="admin-user" class="w-full p-4 rounded-xl border input-field"></div>
<div><label class="text-xs font-bold text-gray-500 uppercase">Pass</label><input type="password" id="admin-pass" class="w-full p-4 rounded-xl border input-field"></div>
</div>
<div class="flex gap-2"><button type="button" onclick="resetLogin()" class="px-4 py-3 bg-gray-200 text-gray-600 rounded-xl font-bold">กลับ</button><button type="submit" class="flex-1 py-3 btn-primary rounded-xl font-bold">เข้าสู่ระบบ</button></div>
</form>
</div>
</div>
</div>`;
}

function toggleLogin(mode) { document.getElementById('login-buttons').classList.add('hidden'); document.getElementById('login-form-container').classList.remove('hidden'); if(mode==='student'){document.getElementById('input-student').classList.remove('hidden');document.getElementById('input-admin').classList.add('hidden');}else{document.getElementById('input-student').classList.add('hidden');document.getElementById('input-admin').classList.remove('hidden');} }
function resetLogin() { document.getElementById('login-form-container').classList.add('hidden'); document.getElementById('login-buttons').classList.remove('hidden'); }
function handleLogin(e) { e.preventDefault(); const idMode = !document.getElementById('input-student').classList.contains('hidden'); if(idMode){ const id = document.getElementById('login-id').value.trim(); const u = studentsData.find(s => String(s.national_id).trim() === String(id)); if(u){currentUser = u; currentView = 'student'; render();}else showAlert('ไม่พบข้อมูล', 'ไม่พบเลขบัตรฯ'); }else{ if(document.getElementById('admin-user').value === 'admin' && document.getElementById('admin-pass').value === 'admin11275'){currentView='admin';render();}else showAlert('ผิดพลาด', 'Pass ผิด'); } }

function renderAdminDashboard() {
const m1 = studentsData.filter(s => ['p4','p5','p6','m1'].includes(s.grade_level));
const m4 = studentsData.filter(s => ['m3','m4'].includes(s.grade_level));
let active = adminTab === 'm1' ? m1 : m4;
if(searchQuery) active = active.filter(s => s.full_name.includes(searchQuery) || String(s.exam_id).includes(searchQuery) || String(s.national_id).includes(searchQuery));
checkedIds.clear();

document.getElementById('app').innerHTML = `
<div class="h-full flex flex-col md:flex-row bg-[#f8fafc]">
<div id="sidebar" class="w-64 bg-white flex flex-col p-6 shadow-xl hidden md:flex">
<h2 class="font-bold mb-8">แอดมิน</h2>
<div class="space-y-2 flex-1">
<button class="sidebar-btn ${adminTab==='m1'?'active':''}" onclick="adminTab='m1';render()">ข้อมูล ม.1</button>
<button class="sidebar-btn ${adminTab==='m4'?'active':''}" onclick="adminTab='m4';render()">ข้อมูล ม.4</button>
<button class="sidebar-btn border-t pt-4 text-lime-600" onclick="showAddStudentForm()">+ เพิ่มผู้เข้าสอบ</button>
</div>
<button class="sidebar-btn text-red-400 mt-auto" onclick="currentView='login';render()">ออก</button>
</div>
<div class="flex-1 overflow-auto p-4 md:p-10">
<h1 class="text-2xl font-bold mb-6">ผู้สอบ ${adminTab==='m1'?'ม.1':'ม.4'} (${active.length})</h1>
<div class="bg-white p-2 rounded-2xl shadow-sm mb-6 flex gap-2">
<input type="text" id="search-input" class="flex-1 p-3 bg-gray-50 rounded-xl" placeholder="ค้นหา..." value="${searchQuery}" onkeydown="if(event.key==='Enter') searchQuery=this.value;render()">
<button onclick="searchQuery=document.getElementById('search-input').value;render()" class="px-8 bg-lime-400 text-white rounded-xl font-bold">ค้น</button>
<button id="btn-bulk-delete" onclick="executeBulkDelete()" class="hidden px-4 bg-red-400 text-white rounded-xl">ลบ (<span id="selected-count">0</span>)</button>
</div>
<div class="grid grid-cols-3 gap-4 mb-6">
<div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-lime-300 flex justify-between"><span>สูงสุด</span><b class="text-lime-600">${active.length?Math.max(...active.map(s=>s.total_score)).toFixed(2):0}</b></div>
<div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-red-300 flex justify-between"><span>ต่ำสุด</span><b class="text-red-400">${active.length?Math.min(...active.map(s=>s.total_score)).toFixed(2):0}</b></div>
<div class="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-amber-300 flex justify-between"><span>เฉลี่ย</span><b class="text-amber-400">${active.length?(active.reduce((a,b)=>a+b.total_score,0)/active.length).toFixed(2):0}</b></div>
</div>
<div class="bg-white rounded-3xl border overflow-hidden">
<table class="w-full text-left">
<thead class="bg-lime-50"><tr><th class="p-4 text-center w-10"><input type="checkbox" onchange="toggleAllCheckboxes(this)"></th><th class="p-4">รหัส</th><th class="p-4">ชื่อ</th><th class="p-4">ชั้น</th><th class="p-4">คะแนน</th><th class="p-4 text-center">จัดการ</th></tr></thead>
<tbody class="divide-y">${active.map(s => `<tr><td class="p-4 text-center"><input type="checkbox" value="${s.__backendId}" onchange="toggleCheckbox('${s.__backendId}')" class="row-checkbox"></td><td class="p-4 font-mono text-lime-600">${s.exam_id}</td><td class="p-4">${s.full_name}</td><td class="p-4">${getThaiGrade(s.grade_level)}</td><td class="p-4 font-bold text-amber-500">${s.total_score}</td><td class="p-4 text-center"><button onclick="showEditForm('${s.__backendId}')" class="text-lime-500">แก้</button> <button onclick="deleteStudent('${s.__backendId}')" class="text-red-400">ลบ</button></td></tr>`).join('')}</tbody>
</table>
</div>
</div>
</div>`;
}

function renderStudentView() {
if(!currentUser) return;
const maxSci=40, maxMath=30, maxEng=30, s=currentUser;
const pSci=(s.science_score/maxSci)*100, pMath=(s.math_score/maxMath)*100, pEng=(s.english_score/maxEng)*100;
document.getElementById('app').innerHTML = `
<div class="h-full bg-[#fdfbf7] overflow-auto">
<div class="gradient-bg h-48 w-full absolute top-0 z-0 rounded-b-[3rem] shadow-lg opacity-90"></div>
<div class="relative z-10 max-w-4xl mx-auto p-4 pt-8 pb-10">
<div class="flex justify-between items-start mb-6"><div class="text-lime-900 font-bold">ประกาศผลแข่งขันทักษะ<br>เพชรราชพฤกษ์ 2569</div><button onclick="location.reload()" class="bg-white/80 text-red-500 px-4 py-2 rounded-full text-xs font-bold">ออก</button></div>
<div class="bg-white rounded-[2rem] p-6 shadow-xl mb-6 relative overflow-hidden border border-lime-100">
<h2 class="text-2xl font-bold text-gray-800">${s.full_name}</h2><p class="text-lime-600 font-medium mb-4">${getThaiGrade(s.grade_level)}</p>
<div class="grid gap-2 text-sm text-gray-600 bg-gray-50 p-4 rounded-xl"><div class="flex justify-between"><span>รหัสประจำตัวสอบ</span><b>${s.exam_id}</b></div><div class="flex justify-between"><span>โรงเรียนปัจจุบัน</span><b>${s.previous_school}</b></div></div>
</div>
<h3 class="font-bold text-lg mb-4 ml-2">คะแนนรายวิชา</h3>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
<div class="bg-white p-5 rounded-2xl border flex flex-col group"><div class="flex justify-between text-xs font-bold text-gray-400 uppercase mb-2"><span>วิทยาศาสตร์</span><span>เต็ม 40</span></div><div class="flex justify-between items-end mb-2"><b>${s.science_score}</b><span class="text-[10px] text-blue-600">ร้อยละ ${pSci.toFixed(1)}</span></div><div class="bg-gray-100 h-2 rounded-full overflow-hidden"><div class="bg-blue-400 h-2" style="width:${pSci}%"></div></div></div>
<div class="bg-white p-5 rounded-2xl border flex flex-col group"><div class="flex justify-between text-xs font-bold text-gray-400 uppercase mb-2"><span>คณิตศาสตร์</span><span>เต็ม 30</span></div><div class="flex justify-between items-end mb-2"><b>${s.math_score}</b><span class="text-[10px] text-red-600">ร้อยละ ${pMath.toFixed(1)}</span></div><div class="bg-gray-100 h-2 rounded-full overflow-hidden"><div class="bg-red-400 h-2" style="width:${pMath}%"></div></div></div>
<div class="bg-white p-5 rounded-2xl border flex flex-col group"><div class="flex justify-between text-xs font-bold text-gray-400 uppercase mb-2"><span>อังกฤษ</span><span>เต็ม 30</span></div><div class="flex justify-between items-end mb-2"><b>${s.english_score}</b><span class="text-[10px] text-purple-600">ร้อยละ ${pEng.toFixed(1)}</span></div><div class="bg-gray-100 h-2 rounded-full overflow-hidden"><div class="bg-purple-400 h-2" style="width:${pEng}%"></div></div></div>
</div>
<div class="bg-amber-400 p-8 rounded-[2.5rem] text-center text-white shadow-lg"><p class="text-xs uppercase font-bold opacity-80 mb-1">คะแนนรวม 3 วิชา (100)</p><p class="text-6xl font-black">${s.total_score.toFixed(2)}</p></div>
<div class="mt-8 text-center text-xs text-gray-400">ครูอานนท์ เมืองแก้ว</div>
</div>
</div>`;
}

function switchAddTab(tn) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(`tab-${tn}`).classList.add('active'); ['single','multiple','excel','score'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden')); document.getElementById(`view-${tn}`).classList.remove('hidden'); }
function showAddStudentForm() { openModal(); document.getElementById('student-form').reset(); switchAddTab('single'); }
function showEditForm(id) { 
const s = studentsData.find(x => x.__backendId === id); if(!s) return;
document.getElementById('student-backend-id').value = s.__backendId; document.getElementById('form-national-id').value = s.national_id; document.getElementById('form-exam-id').value = s.exam_id; document.getElementById('form-grade').value = s.grade_level.toLowerCase(); document.getElementById('form-name').value = s.full_name; document.getElementById('form-school').value = s.previous_school; document.getElementById('score-science').value = s.science_score; document.getElementById('score-math').value = s.math_score; document.getElementById('score-english').value = s.english_score;
openModal(); switchAddTab('single');
}
function handleSingleSubmit(e) {
e.preventDefault();
const s=parseFloat(document.getElementById('score-science').value)||0, m=parseFloat(document.getElementById('score-math').value)||0, en=parseFloat(document.getElementById('score-english').value)||0;
const data = {
__backendId: document.getElementById('student-backend-id').value,
exam_id: document.getElementById('form-exam-id').value, national_id: document.getElementById('form-national-id').value, grade_level: document.getElementById('form-grade').value, full_name: document.getElementById('form-name').value, previous_school: document.getElementById('form-school').value, science_score: s, math_score: m, english_score: en, total_score: s+m+en
};
showLoading('บันทึก...');
const act = formMode==='create'?window.dataSdk.create(data):window.dataSdk.update(data);
act.then(res => { setTimeout(() => { hideLoading(); if(res.isOk){ closeModal(); showAlert('สำเร็จ','บันทึกเรียบร้อย'); } else showAlert('พลาด',res.error.message); },500); });
}
function addMultipleRow() { const tr = document.createElement('tr'); tr.className = 'bg-white border-b'; tr.innerHTML = `<td class="p-2"><input type="text" class="w-full border rounded multi-national-id text-xs"></td><td class="p-2"><input type="text" class="w-full border rounded multi-exam-id text-xs"></td><td class="p-2"><input type="text" class="w-full border rounded multi-name text-xs"></td><td class="p-2"><select class="w-full border multi-grade text-xs"><option value="p6">ป.6</option><option value="p5">ป.5</option><option value="p4">ป.4</option><option value="m3">ม.3</option></select></td><td class="p-2"><input type="text" class="w-full border rounded multi-school text-xs"></td><td class="p-2 text-center"><button type="button" onclick="this.closest('tr').remove()" class="text-red-500">x</button></td>`; document.getElementById('multiple-tbody').appendChild(tr); }
function handleMultipleSubmit() { /* ตามเดิมที่ท่านส่ง */ }
function handleExcelUpload(i, t) { if(!i.files[0]) return; const rd = new FileReader(); rd.onload = (e) => { const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'}); const jd = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1}); if(t==='student'){ excelDataCache = jd.slice(1).map(r => ({ exam_id: String(r[0]), national_id: String(r[1]), full_name: String(r[2]), grade_level: String(r[3]), previous_school: String(r[4]) })); document.getElementById('excel-preview-table').innerHTML = excelDataCache.slice(0,5).map(r=>`<tr><td>${r.exam_id}</td><td>${r.full_name}</td></tr>`).join(''); document.getElementById('excel-preview-area').classList.remove('hidden'); } }; rd.readAsArrayBuffer(i.files[0]); }
function confirmExcelImport(t) { /* ตามเดิมที่ท่านส่ง */ }
function deleteStudent(id) { showConfirm('ลบ?','ลบคนนี้?',()=>{ showLoading('ลบ...'); window.dataSdk.delete({__backendId:id}).then(res=>{ hideLoading(); if(res.isOk) showAlert('สำเร็จ','ลบแล้ว'); }); }); }

window.addEventListener('load', () => { window.dataSdk.init(dataHandler); render(); });
</script>
</body>
</html>
